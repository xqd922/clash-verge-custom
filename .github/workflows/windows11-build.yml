name: Windows 11 Build

name: Windows 11 Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ç•™ç©ºåˆ™è‡ªåŠ¨è·å–)'
        required: false
        type: string
      create_release:
        description: 'åˆ›å»º GitHub Release'
        required: false
        default: true
        type: boolean
  push:
    tags:
      - "v*"
    branches:
      - main
      - master
    paths:
      - 'src/**'
      - 'src-tauri/**'
      - 'package.json'
      - '.github/workflows/windows11-build.yml'

permissions: write-all

jobs:
  windows11-build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            arch: x64
          - target: aarch64-pc-windows-msvc
            arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Target
        run: rustup target add ${{ matrix.target }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install Dependencies
        run: |
          pnpm install
          pnpm check ${{ matrix.target }}

      - name: Build
        uses: tauri-apps/tauri-action@v0
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: pnpm
          args: --target ${{ matrix.target }}

      - name: Get Version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            $version = "${{ github.event.inputs.version }}"
            Write-Host "ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬: $version"
          } else {
            $version = (Get-Content package.json | ConvertFrom-Json).version
            Write-Host "ä» package.json è·å–ç‰ˆæœ¬: $version"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "BUILD_TIME=$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $env:GITHUB_OUTPUT
          echo "COMMIT_SHA=$($env:GITHUB_SHA.Substring(0,8))" >> $env:GITHUB_OUTPUT

      - name: Create Windows 11 Package
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $arch = "${{ matrix.arch }}"
          $target = "${{ matrix.target }}"
          
          # Create output directory
          New-Item -ItemType Directory -Path "windows11-release" -Force
          
          # Copy installer if exists
          $installerPath = "src-tauri\target\$target\release\bundle\nsis\Clash Verge_${version}_${arch}-setup.exe"
          if (Test-Path $installerPath) {
            $newName = "Clash-Verge-Rev-${version}-Windows11-${arch}-setup.exe"
            Copy-Item $installerPath "windows11-release\$newName"
            Write-Host "Created installer: $newName"
          }
          
          # Create portable version
          $exePath = "src-tauri\target\$target\release\clash-verge.exe"
          if (Test-Path $exePath) {
            $portableDir = "Clash-Verge-Rev-${version}-Windows11-${arch}-Portable"
            New-Item -ItemType Directory -Path $portableDir -Force
            
            Copy-Item $exePath "$portableDir\Clash-Verge-Rev.exe"
            
            # Create README
            $readme = @'
# Clash Verge Rev - Windows 11 ä¸“ç‰ˆ

## ç‰ˆæœ¬ä¿¡æ¯
- ç‰ˆæœ¬å·: {0}
- æ¶æ„: {1}
- æ„å»ºæ—¶é—´: {2}
- Git æäº¤: {3}
- ç›®æ ‡ç³»ç»Ÿ: Windows 11

## å®‰è£…è¯´æ˜
### å®‰è£…åŒ…ç‰ˆæœ¬
- è¿è¡Œ setup.exe æ–‡ä»¶è¿›è¡Œæ ‡å‡†å®‰è£…
- æ”¯æŒè‡ªåŠ¨æ›´æ–°å’Œå¸è½½

### ä¾¿æºç‰ˆæœ¬
- è§£å‹åç›´æ¥è¿è¡Œ Clash-Verge-Rev.exe
- æ— éœ€å®‰è£…ï¼Œè®¾ç½®ä¿å­˜åœ¨ç¨‹åºç›®å½•
- é€‚åˆä¸´æ—¶ä½¿ç”¨æˆ–å¤šç‰ˆæœ¬å¹¶å­˜

## ç³»ç»Ÿè¦æ±‚
- Windows 11 (æ¨è)
- Windows 10 version 1903 æˆ–æ›´é«˜ç‰ˆæœ¬
- .NET Framework 4.7.2 æˆ–æ›´é«˜ç‰ˆæœ¬
- WebView2 è¿è¡Œæ—¶ (é€šå¸¸ç³»ç»Ÿè‡ªå¸¦)

## æ›´æ–°æ—¥å¿—
è¯·è®¿é—® GitHub Releases é¡µé¢æŸ¥çœ‹è¯¦ç»†æ›´æ–°æ—¥å¿—
'@ -f $version, $arch, "${{ steps.version.outputs.BUILD_TIME }}", "${{ steps.version.outputs.COMMIT_SHA }}"
            Set-Content -Path "$portableDir\README.txt" -Value $readme
            
            # Create portable zip
            Compress-Archive -Path $portableDir -DestinationPath "windows11-release\Clash-Verge-Rev-${version}-Windows11-${arch}-Portable.zip"
            Write-Host "Created portable: Clash-Verge-Rev-${version}-Windows11-${arch}-Portable.zip"
          }

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clash-verge-rev-windows11-${{ matrix.arch }}-v${{ steps.version.outputs.VERSION }}
          path: windows11-release/*
          retention-days: 30
          if-no-files-found: warn

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', steps.version.outputs.VERSION) }}
          name: "Clash Verge Rev ${{ steps.version.outputs.VERSION }} - Windows 11 ä¸“ç‰ˆ"
          body: |
            ## ğŸ‰ Clash Verge Rev Windows 11 ä¸“ç‰ˆå‘å¸ƒ
            
            ### ğŸ“¦ ä¸‹è½½é€‰é¡¹
            - **setup.exe**: æ ‡å‡†å®‰è£…ç¨‹åº (æ¨èæ–°ç”¨æˆ·)
              - è‡ªåŠ¨é…ç½®ç³»ç»Ÿé›†æˆ
              - æ”¯æŒè‡ªåŠ¨æ›´æ–°
              - å®Œæ•´çš„å¸è½½æ”¯æŒ
            
            - **Portable.zip**: ä¾¿æºç‰ˆæœ¬ (æ¨èé«˜çº§ç”¨æˆ·)
              - æ— éœ€å®‰è£…ï¼Œè§£å‹å³ç”¨
              - è®¾ç½®ä¾¿æºåŒ–å­˜å‚¨
              - æ”¯æŒå¤šç‰ˆæœ¬å¹¶å­˜
            
            ### ğŸ—ï¸ æ¶æ„æ”¯æŒ
            - **x64**: Intel/AMD 64ä½å¤„ç†å™¨ (æ¨è)
            - **arm64**: ARM64 æ¶æ„å¤„ç†å™¨ (Surface Pro X ç­‰)
            
            ### ğŸ’» ç³»ç»Ÿè¦æ±‚
            - Windows 11 (æ¨èï¼Œå®Œæ•´åŠŸèƒ½æ”¯æŒ)
            - Windows 10 version 1903+ (åŸºç¡€åŠŸèƒ½æ”¯æŒ)
            - WebView2 è¿è¡Œæ—¶ (ç°ä»£ Windows ç³»ç»Ÿé€šå¸¸å·²é¢„è£…)
            
            ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
            - ç‰ˆæœ¬: ${{ steps.version.outputs.VERSION }}
            - æ„å»ºæ—¶é—´: ${{ steps.version.outputs.BUILD_TIME }}
            - Git æäº¤: ${{ steps.version.outputs.COMMIT_SHA }}
            
            ### ğŸ”„ æ›´æ–°è¯´æ˜
            æ­¤ç‰ˆæœ¬ä¸“ä¸º Windows 11 ä¼˜åŒ–ï¼Œæä¾›æ›´å¥½çš„æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚
            
            ---
            **æ³¨æ„**: é¦–æ¬¡ä½¿ç”¨è¯·å‚è€ƒ [ä½¿ç”¨æ–‡æ¡£](https://github.com/clash-verge-rev/clash-verge-rev/wiki) è¿›è¡Œé…ç½®ã€‚
          files: windows11-release/*
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'alpha') || contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'rc') }}