#!/usr/bin/env node

import { execSync } from "child_process";
import fs from "fs-extra";
import path from "path";

const ARCH = process.argv[2] || "x64";
const VERSION = process.env.npm_package_version || "2.1.0";

console.log(`ğŸš€ å¼€å§‹æ„å»º Windows 11 ä¸“ç‰ˆ - ${ARCH} æ¶æ„`);

// æ„å»ºç›®æ ‡æ˜ å°„
const targetMap = {
  x64: "x86_64-pc-windows-msvc",
  arm64: "aarch64-pc-windows-msvc",
  x86: "i686-pc-windows-msvc"
};

const target = targetMap[ARCH];
if (!target) {
  console.error(`âŒ ä¸æ”¯æŒçš„æ¶æ„: ${ARCH}`);
  process.exit(1);
}

try {
  // 1. æ¸…ç†ä¹‹å‰çš„æ„å»º
  console.log("ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶...");
  
  // 2. å®‰è£…ä¾èµ–
  console.log("ğŸ“¦ å®‰è£…ä¾èµ–...");
  execSync("pnpm install", { stdio: "inherit" });
  
  // 3. æ£€æŸ¥ç›®æ ‡
  console.log(`ğŸ” æ£€æŸ¥æ„å»ºç›®æ ‡: ${target}`);
  execSync(`pnpm check ${target}`, { stdio: "inherit" });
  
  // 4. æ„å»ºåº”ç”¨
  console.log(`ğŸ”¨ å¼€å§‹æ„å»º ${ARCH} ç‰ˆæœ¬...`);
  execSync(`pnpm build --target ${target}`, { 
    stdio: "inherit",
    env: {
      ...process.env,
      NODE_OPTIONS: "--max_old_space_size=4096"
    }
  });
  
  // 5. åˆ›å»ºä¾¿æºç‰ˆ
  console.log("ğŸ“¦ åˆ›å»ºä¾¿æºç‰ˆ...");
  await createPortableVersion(target, ARCH, VERSION);
  
  console.log("âœ… Windows 11 ä¸“ç‰ˆæ„å»ºå®Œæˆï¼");
  
} catch (error) {
  console.error("âŒ æ„å»ºå¤±è´¥:", error.message);
  process.exit(1);
}

async function createPortableVersion(target, arch, version) {
  const exePath = `src-tauri/target/${target}/release/clash-verge.exe`;
  
  if (!fs.existsSync(exePath)) {
    console.warn("âš ï¸  å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¾¿æºç‰ˆåˆ›å»º");
    return;
  }
  
  const portableDir = `Clash-Verge-Rev-${version}-Windows11-${arch}-Portable`;
  
  // åˆ›å»ºä¾¿æºç‰ˆç›®å½•
  await fs.ensureDir(portableDir);
  
  // å¤åˆ¶ä¸»ç¨‹åº
  await fs.copy(exePath, path.join(portableDir, "Clash-Verge-Rev.exe"));
  
  // åˆ›å»ºä¾¿æºç‰ˆæ ‡è¯†
  await fs.writeFile(
    path.join(portableDir, "portable.txt"),
    "This is a portable version of Clash Verge Rev for Windows 11"
  );
  
  // åˆ›å»ºREADME
  const readmeContent = `# Clash Verge Rev - Windows 11 Portable Version

## ä½¿ç”¨è¯´æ˜ / Usage Instructions

### ä¸­æ–‡è¯´æ˜ï¼š
1. ç›´æ¥è¿è¡Œ Clash-Verge-Rev.exe å³å¯å¯åŠ¨ç¨‹åº
2. ä¾¿æºç‰ˆä¼šåœ¨å½“å‰ç›®å½•åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œæ— éœ€å®‰è£…
3. é€‚ç”¨äº Windows 11 ç³»ç»Ÿ
4. æ”¯æŒ ${arch} æ¶æ„

### English Instructions:
1. Run Clash-Verge-Rev.exe directly to start the application
2. Portable version creates config files in current directory, no installation required
3. Compatible with Windows 11
4. Supports ${arch} architecture

## ç‰ˆæœ¬ä¿¡æ¯ / Version Info
- Version: ${version}
- Architecture: ${arch}
- Build Time: ${new Date().toLocaleString()}
- Target: Windows 11

## ç³»ç»Ÿè¦æ±‚ / System Requirements
- Windows 11 (æ¨è / Recommended)
- Windows 10 version 1903 æˆ–æ›´é«˜ç‰ˆæœ¬ / or higher
`;
  
  await fs.writeFile(path.join(portableDir, "README.md"), readmeContent);
  
  console.log(`âœ… ä¾¿æºç‰ˆåˆ›å»ºå®Œæˆ: ${portableDir}`);
}